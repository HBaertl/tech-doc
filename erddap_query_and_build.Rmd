# Data and code access {#erddap}

```{r setup,  echo = F, message=F}

#Load packages
library(knitr)
library(rmarkdown)


```


### About

The Technical Documentation for the State of the Ecosystem reports is a [bookdown](https://bookdown.org) document; hosted on the NOAA Northeast Fisheries Science Center Ecosystems Dynamics and Assessment Branch [Github page](https://github.com/NOAA-EDAB), and developed in R. Derived data used to populate figures in this document are queried directly from the NEFSC [ERDDAP server](https://comet.nefsc.noaa.gov/erddap/info/index.html?page=1&itemsPerPage=1000) using the R package [rerddap](https://cran.r-project.org/web/packages/rerddap/vignettes/Using_rerddap.html).  

### Data and code access

Source data for the derived indicators in this document are linked to in the text unless there are privacy concerns involved. In that case, it may be possible to access source data by reaching out to the Point of Contact associated with that data set. Derived data sets make up the majority of the indicators present in the State of the Ecosystem reports. The majority of derived data sets are available for download through the NEFSC [ERDDAP server](https://comet.nefsc.noaa.gov/erddap/info/index.html?page=1&itemsPerPage=1000), although some data is also present in the [Github repository](https://github.com/NOAA-EDAB/tech-memo) associated with this document. 

In this technical documentation, we hope to shine a light on the processing and analytical steps involved to get from source data to final product. This means that whenever possible, we have included the code involved in source data extraction, processing, and analytses. We have also attempted to thoroughly describe all methods in place of or in supplement to provided code. 

There are multiple R scripts sourced throughout this document in an attempt to keep code concise. These scripts include [BasePlot_source.R](https://github.com/NOAA-EDAB/tech-memo/blob/master/R/BasePlot_source.R), [GIS_source.R](https://github.com/NOAA-EDAB/tech-memo/blob/master/R/GIS_source.R), and [get_erddap.R](https://github.com/NOAA-EDAB/tech-memo/blob/master/R/get_erddap.R). These scripts along with the code presented in sections titled "Plotting" may be used to recreate any figures present in State of the Ecosystem reports. The script [get_erddap.R](https://github.com/NOAA-EDAB/tech-memo/blob/master/R/get_erddap.R) is used to both query individual data sets and to build a parent data set containing all indicator data. The exact usage in the latter case is shown below. 

### ERDDAP queries



```{r query, echo = T, eval = T, message=F, warning=F}

#Libraries
library(dplyr)
library(rerddap)
library(stringr)
library(data.table)

# Relative working directories
data.dir  <- here::here('data')
image.dir <- here::here('images')
r.dir <- here::here('R')

#Source function for querying ERDDAP server
source(file.path(r.dir,"get_erddap.R"))

#Set URL for COMET (server where NEFSC ERDDAP lives)
comet <- 'https://comet.nefsc.noaa.gov/erddap/'

#List datasets on the NEFSC ERDDAP
tab_list <- ed_datasets(url = comet)

#Get updated data set IDs
erddap_datasets <- tab_list %>% 
  filter(str_detect(Dataset.ID, "soe_v")) %>% 
  get_erddap(id = NULL)

#Save and clean updated IDs for use in rest of report
save(erddap_datasets, file = file.path(data.dir, "ERDDAP_datasets.Rdata"))
  
erddap_datasets <- erddap_datasets %>%
  dplyr::filter(!str_detect(Dataset.ID, "assess")) 

#Create SOE data set, filter out NAs
SOE.data.2018.erd <- sprintf("http://comet.nefsc.noaa.gov/erddap/tabledap/%s.csv",
                         erddap_datasets$Dataset.ID) %>% 
  purrr::map(function(x) {
    readr::read_csv(url(x))
  }) %>% 
  do.call(rbind,.) %>% 
  mutate(Value = as.numeric(Value)) %>% 
    dplyr::filter(!is.na(Value))

#Convert to data.table
SOE.data.2018 <- as.data.table(SOE.data.2018.erd)

#Save data
save(SOE.data.2018, file = file.path(data.dir,"SOE_data_2018_erddap.Rdata"))

```


