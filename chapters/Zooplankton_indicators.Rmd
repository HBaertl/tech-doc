# Zooplankton {#zooabund}

```{r,  echo = F, message=F}

#Load packages
library(knitr)
library(rmarkdown)

```

**Description**: Annual time series of zooplankton abundance

**Found in**: State of the Ecosystem - Gulf of Maine & Georges Bank (2017, 2018, 2019), State of the Ecosystem - Mid-Atlantic (2017, 2018, 2019)

**Indicator category**: Database pull with analysis; Synthesis of published information; Extensive analysis, not yet published; Published methods

**Contributor(s)**: Ryan Morse, Kevin Friedland
  
**Data steward**: Harvey Walsh, <harvey.walsh@noaa.gov>; Mike Jones, <michael.jones@noaa.gov>
  
**Point of contact**: Ryan Morse, <ryan.morse@noaa.gov>; Harvey Walsh, <harvey.walsh@noaa.gov>; Kevin Friedland, <kevin.friedland@noaa.gov>
  
**Public availability statement**: Source data are publicly available [here](ftp://ftp.nefsc.noaa.gov/pub/hydro/zooplankton_data/). Derived data can be found [here](https://comet.nefsc.noaa.gov/erddap/tabledap/zoo_abundance_soe_v1.html).

## Methods

### Data sources
Zooplankton data are from the NOAA MARMAP and EcoMon cruises detailed extensively in @Kane2007, @Kane2011, and @Morse2017.

### Data extraction 
Data are from the publicly available zooplankton dataset on the NOAA FTP server. The excel file has a list of excluded samples and cruises based on @Kane2007 and @Kane2011.

R code used in extraction process.
```{r, echo = T, eval = F}
# load data
URL='ftp://ftp.nefsc.noaa.gov/pub/hydro/zooplankton_data/EcoMon_Plankton_Data_v3_0.xlsx'
ZPD=openxlsx::read.xlsx(URL, sheet='Data')
```

### Data analysis

**Annual abundance anomalies**

Data are processed similarly to @Kane2007 and @Perretti2017a, where a mean annual abundance by date is computed by area for each species meeting inclusion metrics set in @Morse2017. This is accomplished by binning all samples for a given species to bi-monthly collection dates based on median cruise date and taking the mean, then fitting a spline interpolation between mean bi-monthly abundance to give expected abundance on any given day of the year. 

Abundance anomalies (Figure \@ref(fig:zooplankton-abundance)) are computed from the expected abundance on the day of sample collection. Abundance anomaly time series are constructed for *Centropages typicus*, *Pseudocalanus* spp., *Calanus finmarchicus*, and total zooplankton biovolume. The small-large copepod size index is computed by averaging the individual abundance anomalies of *Pseudocalanus* spp., *Centropages hamatus*, *Centropages typicus*, and *Temora longicornis*, and subtracting the abundance anomaly of *Calanus finmarchicus*. This index tracks the overall dominance of the small bodied copepods relative to the largest copepod in the NEUS region, *Calanus finmarchicus*.

```{r, echo = T, eval = F}

#libraries
library(vegan)
library(stats)
library(mgcv)
library(reshape2)
library(readxl)
library(lubridate)
library(sp)
library(maptools)
library(marmap)
library(rgeos)


# load data
URL='ftp://ftp.nefsc.noaa.gov/pub/hydro/zooplankton_data/EcoMon_Plankton_Data_v3_0.xlsx'
ZPD=openxlsx::read.xlsx(URL, sheet='Data')
# Fix date, time
dt=as_date(ZPD$date, origin = "1899-12-30")
DOY=yday(dt) #day of year
month=as.numeric(format(dt, '%m'))
year=as.numeric(format(dt, '%Y'))
ZPD$year=year
ZPD$month=month
ZPD$dt=dt
ZPD$DOY=DOY
ZPD$day=as.numeric(format(dt, '%d'))
ZPD$lat2=ceiling(ZPD$lat) #use for binning into 1 degree bins for removal of undersampled bins
ZPD$lon2=floor(ZPD$lon) #use for binning into 1 degree bins for removal of undersampled bins
# ASSIGN EPU based on GPS data
## load shapefiles from EDAB EPU analysis ## not available here

gbk=readShapeSpatial("EPU_GBKPoly.shp")
gom=readShapeSpatial("EPU_GOMPoly.shp")
mab=readShapeSpatial("EPU_MABPoly.shp")
scs=readShapeSpatial("EPU_SCSPoly.shp")
#combine shapefiles GOM and GBK
gom.gbk.shp=gUnion(gom, gbk, byid=F, id=NULL)
gom.gbk.shp=gUnion(gom, gbk, byid=F, id=NULL)
gom.scs.shp=gUnion(gom, scs, byid=F, id=NULL)
mab.gbk.shp=gUnion(mab, gbk, byid=F, id=NULL)
NES.shp=gUnion(mab.gbk.shp, gom.scs.shp, byid=F, id=NULL)
#extract just lat/lons for lines
gbk.lonlat =as.data.frame(lapply(slot(gbk, "polygons"), function(x) lapply(slot(x, "Polygons"), function(y) slot(y, "coords"))))
gom.lonlat =as.data.frame(lapply(slot(gom, "polygons"), function(x) lapply(slot(x, "Polygons"), function(y) slot(y, "coords"))))
mab.lonlat =as.data.frame(lapply(slot(mab, "polygons"), function(x) lapply(slot(x, "Polygons"), function(y) slot(y, "coords"))))
scs.lonlat =as.data.frame(lapply(slot(scs, "polygons"), function(x) lapply(slot(x, "Polygons"), function(y) slot(y, "coords"))))
gom.gbk.lonlat =as.data.frame(lapply(slot(gom.gbk.shp, "polygons"), function(x) lapply(slot(x, "Polygons"), function(y) slot(y, "coords"))))
NES.lonlat =as.data.frame(NES.shp@polygons[[1]]@Polygons[[1]]@coords)# create matrix to use in in.out function
# create matrix to use in in.out function from package 'mgcv'
gom.mat=as.matrix(gom.lonlat)
gbk.mat=as.matrix(gbk.lonlat)
mab.mat=as.matrix(mab.lonlat)
scs.mat=as.matrix(scs.lonlat)
gom.gbk.mat=as.matrix(gom.gbk.lonlat)
# assign samples to EPU
m4=as.matrix(ZPD[,6:5]) #lon,lat from ZPD
ZPD$epu=NA
ZPD$epu[which(in.out(gbk.mat, m4))]='GBK'
ZPD$epu[which(in.out(gom.mat, m4))]='GOM'
ZPD$epu[which(in.out(scs.mat, m4))]='SCS'
ZPD$epu[which(in.out(mab.mat, m4))]='MAB'
test=ZPD[is.na(ZPD$epu),] #unassigned
nms=data.frame(colnames(ZPD)) # column names of orginal data
# limit data set to zooplankton from 1977 on
ZPDb=ZPD[,c(seq(1,14,1), seq(290,297,1), seq(106,197,1))] # check to make sure these are correct against 'nms' if data source changes!!!
ZPDb=ZPDb[order(ZPDb$date),]
ZPDb=ZPDb[which(ZPDb$year > 1976),] # remove NA data in years prior to 1977
# Select only taxa present in yearly data > x percent of samples
X=20 # percent criteria to use as minimum percent in samples
ZPDa=ZPDb
ZPDa=ZPDa[!is.na(ZPDa$zoo_gear),] # Remove NA in zooplankton rows
# Reduce to taxa occurrance > x percent in samples
p.a=ZPDa[,24:114]
p.a[p.a > 0]=1 # presence/absence
count=colSums(p.a)
pct=(count/dim(ZPDa)[1])*100
crit=which(pct>X)
ZPDa=ZPDa[c(1:23,crit+23)] # data limited to taxa occurring in > X percent of samples

#Take median date from each cruise and assign cruise to bimonth for bi-monthly means aggregation
cruises=unique(ZPDa$cruise_name)
for (i in 1:length(cruises)){
  ZPDa$medmonth[ZPDa$cruise_name == cruises[i]]=median(ZPDa$DOY[ZPDa$cruise_name == cruises[i]])
}
ZPDa$bmm=NA
ZPDa$bmm[which(as.integer(ZPDa$medmonth) %in% seq(0,59))]=1
ZPDa$bmm[which(as.integer(ZPDa$medmonth) %in% seq(60,120))]=3
ZPDa$bmm[which(as.integer(ZPDa$medmonth) %in% seq(121,181))]=5
ZPDa$bmm[which(as.integer(ZPDa$medmonth) %in% seq(182,243))]=7
ZPDa$bmm[which(as.integer(ZPDa$medmonth) %in% seq(244,304))]=9
ZPDa$bmm[which(as.integer(ZPDa$medmonth) %in% seq(305,366))]=11

ZPDa[,14]=as.numeric(ZPDa[,14])
ZPDa[,23]=as.numeric(ZPDa[,23])
ZPDsave=ZPDa #from above routine, Yearly (all data) 

SEASON='Yearly'
ZPDa=ZPDsave
# LOG transform data using ZPDa from above (select season first)
test=log10(ZPDa[,24:50]+1) #choose columns with zooplankton data
ZPDlog=ZPDa
ZPDlog[,24:50]=test
nm=matrix(colnames(ZPDlog))

area='GBK'
gbk.yr.spln=data.frame()
for (i in 23:50){
  num=i
  name=nm[num,1]
  mean.loc.x=aggregate(ZPDlog[which(ZPDlog$epu==area),num], by=list(ZPDlog$bmm[which(ZPDlog$epu==area)]), FUN=mean, na.rm=T)
  func = splinefun(mean.loc.x[,1], y=mean.loc.x[,2], method="natural",  ties = mean)  
  x.daily=func(seq(1, 12, 0.0302)) #365 days
  gbk.yr.spln=rbind(gbk.yr.spln,x.daily)
}
gbk.yr.spln=t(gbk.yr.spln)
rownames(gbk.yr.spln)=seq(1:365); colnames(gbk.yr.spln)=nm[23:50,1]

area='GOM'
gom.yr.spln=data.frame()
for (i in 23:50){
  num=i
  name=nm[num,1]
  mean.loc.x=aggregate(ZPDlog[which(ZPDlog$epu==area),num], by=list(ZPDlog$bmm[which(ZPDlog$epu==area)]), FUN=mean, na.rm=T)
  func = splinefun(mean.loc.x[,1], y=mean.loc.x[,2], method="natural",  ties = mean)
  x.daily=func(seq(1, 12, 0.0302)) #365 days
  gom.yr.spln=rbind(gom.yr.spln,x.daily)
}
gom.yr.spln=t(gom.yr.spln)
rownames(gom.yr.spln)=seq(1:365); colnames(gom.yr.spln)=nm[23:50,1]

area='MAB'
mab.yr.spln=data.frame()
for (i in 23:50){
  num=i
  name=nm[num,1]
  mean.loc.x=aggregate(ZPDlog[which(ZPDlog$epu==area),num], by=list(ZPDlog$bmm[which(ZPDlog$epu==area)]), FUN=mean, na.rm=T)
  func = splinefun(mean.loc.x[,1], y=mean.loc.x[,2], method="natural",  ties = mean)
  x.daily=func(seq(1, 12, 0.0302)) #365 days
  mab.yr.spln=rbind(mab.yr.spln,x.daily)
}
mab.yr.spln=t(mab.yr.spln)
rownames(mab.yr.spln)=seq(1:365); colnames(mab.yr.spln)=nm[23:50,1]

area='SCS'
scs.yr.spln=data.frame()
for (i in 23:50){
  num=i
  name=nm[num,1]
  mean.loc.x=aggregate(ZPDlog[which(ZPDlog$epu==area),num], by=list(ZPDlog$bmm[which(ZPDlog$epu==area)]), FUN=mean, na.rm=T)
  func = splinefun(mean.loc.x[,1], y=mean.loc.x[,2], method="natural",  ties = mean)
  x.daily=func(seq(1, 12, 0.0302)) #365 days
  scs.yr.spln=rbind(scs.yr.spln,x.daily)
}
scs.yr.spln=t(scs.yr.spln)
rownames(scs.yr.spln)=seq(1:365); colnames(scs.yr.spln)=nm[23:50,1]

# Subtract mean expected value from observed abundance to get anomaly
gbk.anom=ZPDlog[which(ZPDlog$epu=='GBK'),]
gom.anom=ZPDlog[which(ZPDlog$epu=='GOM'),]
mab.anom=ZPDlog[which(ZPDlog$epu=='MAB'),]
scs.anom=ZPDlog[which(ZPDlog$epu=='SCS'),]

gbk.anom.b=data.frame(matrix(NA, nrow = dim(gbk.anom)[1], ncol = dim(gbk.anom)[2]))
for (i in 1:dim(gbk.anom)[1]){
  gbk.anom.b[i,23:50]=gbk.anom[i,23:50]-gbk.yr.spln[which(gbk.anom$DOY[i]==rownames(gbk.yr.spln)),]
}
gom.anom.b=data.frame(matrix(NA, nrow = dim(gom.anom)[1], ncol = dim(gom.anom)[2]))
for (i in 1:dim(gom.anom)[1]){
  gom.anom.b[i,23:50]=gom.anom[i,23:50]-gom.yr.spln[which(gom.anom$DOY[i]==rownames(gom.yr.spln)),]
}
mab.anom.b=data.frame(matrix(NA, nrow = dim(mab.anom)[1], ncol = dim(mab.anom)[2]))
for (i in 1:dim(mab.anom)[1]){
  mab.anom.b[i,23:50]=mab.anom[i,23:50]-mab.yr.spln[which(mab.anom$DOY[i]==rownames(mab.yr.spln)),]
}
scs.anom.b=data.frame(matrix(NA, nrow = dim(scs.anom)[1], ncol = dim(scs.anom)[2]))
for (i in 1:dim(scs.anom)[1]){
  scs.anom.b[i,23:50]=scs.anom[i,23:50]-scs.yr.spln[which(scs.anom$DOY[i]==rownames(scs.yr.spln)),]
}  

scs.anom.b=rbind(scs.anom.b,test)
# Aggregrate by Year, Yearly anomaly by epu
gbk.yr.anom=aggregate(gbk.anom.b, by=list(gbk.anom$year), FUN=mean, na.rm=T); rownames(gbk.yr.anom)=gbk.yr.anom[,1]; gbk.yr.anom[,1]=NULL; colnames(gbk.yr.anom)=colnames(gbk.anom)
gom.yr.anom=aggregate(gom.anom.b, by=list(gom.anom$year), FUN=mean, na.rm=T); rownames(gom.yr.anom)=gom.yr.anom[,1]; gom.yr.anom[,1]=NULL; colnames(gom.yr.anom)=colnames(gom.anom)
mab.yr.anom=aggregate(mab.anom.b, by=list(mab.anom$year), FUN=mean, na.rm=T); rownames(mab.yr.anom)=mab.yr.anom[,1]; mab.yr.anom[,1]=NULL; colnames(mab.yr.anom)=colnames(mab.anom)
scs.yr.anom=aggregate(scs.anom.b, by=list(scs.anom$year), FUN=mean, na.rm=T); rownames(scs.yr.anom)=scs.yr.anom[,1]; scs.yr.anom[,1]=NULL; colnames(scs.yr.anom)=colnames(scs.anom)

# Small-Large body copepod abundance anomaly
lgtx=c(25) #column for Calanus finmarchicus
smtx=c(26,24,28,27) #Pseudocalanus spp, Centropoges typicus, Centropages hamatus, Temora longicornis

dataTsm=gbk.yr.anom[,smtx]
dataTlg=gbk.yr.anom[,lgtx]
anom.gbk=rowMeans(dataTsm)-(dataTlg)
dataTsm=gom.yr.anom[,smtx]
dataTlg=gom.yr.anom[,lgtx]
anom.gom=rowMeans(dataTsm)-(dataTlg)
dataTsm=mab.yr.anom[,smtx]
dataTlg=mab.yr.anom[,lgtx]
anom.mab=rowMeans(dataTsm)-(dataTlg)
dataTsm=scs.yr.anom[,smtx]
dataTlg=scs.yr.anom[,lgtx]
anom.scs=rowMeans(dataTsm)-(dataTlg)
```

**Seasonal abundance**

Time series of zooplankton abundance in the spring and fall months have been presented in the 2019 Mid-Atlantic State of the Ecosystem report. Raw abundance data were sourced from the EcoMon cruises referenced above, and ordinary kriging was used to estimate seasonal abundance over the Northeast Shelf. These data were then aggregated further into time series of mean abundance by Ecological Production Unit. These data are presented in Figure \@ref(fig:MAB-oi-zoo).

### Data processing

Zooplankton abundances indicators were formatted for inclusion in the ecodata R package using the following code.

**Abundance anomaly**

<!-- {{ProcessAbundAnomStart}} -->
```{r, eval = F, echo = T}
# Process zooplankton abundance anomalies and small-large index 

library(dplyr)
library(tidyr)

raw.dir <- here::here("data-raw")

get_zoo_anom_sli <- function(save_clean = F){
  
  load(file.path(raw.dir, "1977_2017_SLI_Calfin_Pseudo_Ctyp.Rdata"))
  
  zoo_anom_sli <- Zooplankton_Primary_Prod %>%
  gather(.,Var, Value, -year) %>% 
  dplyr::rename(Time = year) %>% 
  separate(., Var, c("Var","EPU")) %>% 
  mutate(EPU = plyr::mapvalues(EPU, from = c("gom","gbk","scs","mab"), 
                               to = c("GOM","GB","SS","MAB")),
         Var = plyr::mapvalues(Var, from = c("PseAnom",
                                             "CtyAnom",
                                             "CalAnom",
                                             "SLI"), 
                               to = c("pseudocalanus anomaly",
                                      "centropages anomaly",
                                      "calanus anomaly",
                                      "small-large index")),
         Units = "anomaly")
  
  if (save_clean){
    usethis::use_data(zoo_anom_sli, overwrite = T)
  } else {
    return(zoo_anom_sli)
  }
}
get_zoo_anom_sli(save_clean = T)

```
<!-- {{ProcessAbundAnomEnd}} -->

**Seasonal abundance**

<!-- {{ProcessSeasAbund1Start}} -->
```{r, eval = F, echo = T}
# A general function to process various OI data sets

library(dplyr)
library(tidyr)
library(lubridate)
library(raster)
library(rgdal)
library(sf)

process_oi <- function(variable, type = NULL, season, genus = NULL, epu){
  
  if(!is.null(type) & !variable %in% c("salinity","temperature")){
    stop('type only applicable for variables "salinity" and "temperature"
         as type = "bottom" or type = "surface"')
  } 
  
  if(!is.null(genus) & variable != "zooplankton"){
    stop('genus only applicable for variable "zooplankton"')
  } 
  
  #get compiled down-sampled raster of chosen strata from shapefile. 
  epumask.raster <- get(paste0(tolower(epu),"_rast"))
  
  #get bottom temp data and find mean for stock area--------------------------------------
  
  indir <- here::here("inst","extdata","gridded")
  
  if (variable == "salinity"){
    load(file.path(indir, paste0("sal_",type,"_",season,"_spdf.rdata")))
  } else if (variable == "temperature"){
    load(file.path(indir, paste0("temp_",type,"_",season,"_spdf.rdata")))
  } else if (variable == "chlorophyll"){
    load(file.path(indir, paste0("chl_",season,"_1997-2018.rdata")))
  } else if (variable == "zooplankton"){
    load(file.path(indir, paste0(genus,"_",season,"_zoo_1977-2016.rdata")))
  }
  
  
  #create null df to fill with results
  data = data.frame(array(NA,dim= c(raster::nlayers(ecsa_dat),5)))
  
  #loops through layers in raster brick
  for(i in 1:raster::nlayers(ecsa_dat)){
    #load raster by year
    
    #get file information from title
    layer_id <- stringr::str_extract(names(ecsa_dat)[[i]], "\d.*")
    layer_id <- stringr::str_split(layer_id, "_")
    data[i,1] <- layer_id[[1]][[1]]
    data[i,2] <- layer_id[[1]][[2]]
    data[i,3] <- layer_id[[1]][[3]]
    
    #trim to stock area
    masked.raster = ecsa_dat[[i]]*epumask.raster
    
    #find mean BT of stock area
    data[i,4] = raster::cellStats(masked.raster, stat='mean', na.rm=TRUE)
    data[i,5] = raster::cellStats(masked.raster, stat = 'sd', na.rm=TRUE)
    # 
    # if (layer_id[[1]][[1]] == "1995"){
    #   break
    # }
  }
  x <- as.numeric(data$X1)
  y.out <- data$X4
  y.sd <- data$X5
  
  sd.low <- y.out - y.sd
  sd.high <- y.out + y.sd
  
  # remove 
  if (variable == "zooplankton"){
    if (season == "spring"){
      y.out[x %in% c(1989, 1990, 1991, 1994)] <- NA
      sd.low[x %in% c(1989, 1990, 1991, 1994)] <- NA
      sd.high[x %in% c(1989, 1990, 1991, 1994)] <- NA
    } else if (season == "fall") {
      y.out[x %in% c(1989, 1990, 1992)] <- NA
      sd.low[x %in% c(1989, 1990, 1992)] <- NA
      sd.high[x %in% c(1989, 1990, 1992)] <- NA
    }
  }
  
  if(variable == "chlorophyll"){
    type <- ""
  } else if (variable == "zooplankton"){
    type <- genus
    variable <- "zoo"
  } 
  
  out <- data.frame(Var = paste(paste(type,variable),season),
                    Time = as.numeric(x),
                    Value = y.out,
                    sd.low = sd.low,
                    sd.high = sd.high,
                    Season = season,
                    epu = epu)
  
  out <- out[out$Time > 1968,]
  return(out)
  
  }
```
<!-- {{ProcessSeasAbund1End}} -->

<!-- {{ProcessSeasAbund2Start}} -->
```{r, eval = F, echo = T}
# Process optimally interpolated EcoMon zooplankton data
# 
# These data show estimated zooplankton abundances on the NE Shelf derived from Ecosystem Monitoring Program (EcoMon) 
# sampling. EcoMon conducts shelf-wide bimonthly surveys of the Northeast Large Marine Ecosystem, collecting 
# and ichthyoplankton to a depth of 200 m using paired Bongo samplers with 333 $mu$m mesh netting. Zooplankton 
# abundance data were interpolated across sampling locations using ordinary kriging to create a complete field. 
# Here we present abundance time series for three species: *Centropages typicus*, *Temora longicornis*, and
# *Pseudocalanus* spp. These data are processed in a similar manner to optimally interpolated ocean temperature and
# salinity data sets. More information about the source data and processing methods used to derive these data sets
# can be found at https://noaa-edab.github.io/ECSA/#sec:methodszoo. 

library(tidyr)
library(dplyr)

r.dir <- here::here("data-raw")
source(file.path(r.dir, "process_oi.R"))

if (!all(exists("mab_rast"),
         exists("gb_rast"),
         exists("gom_rast"))){
  message("Loading EPU rasters.")
  source(file.path(r.dir, "create_epu_mask_oi.R"))
} else {
  message("All EPU rasters exist; skipping load step.")
}

get_zoo_oi <- function(save_clean = F){
  
  #MAB---------------------------------------------------------------------------------------------------
  ctyp_fall_mab <- process_oi(variable = "zooplankton", genus = "centropages", season = "fall", epu = "MAB")
  ctyp_spring_mab <- process_oi(variable = "zooplankton", genus = "centropages", season = "spring", epu = "MAB")
  
  tlong_fall_mab <- process_oi(variable = "zooplankton", genus = "temora", season = "fall", epu = "MAB")
  tlong_spring_mab <- process_oi(variable = "zooplankton", genus = "temora", season = "spring", epu = "MAB")
  
  pseudo_fall_mab <- process_oi(variable = "zooplankton", genus = "pseudocalanus", season = "fall", epu = "MAB")
  pseudo_spring_mab <- process_oi(variable = "zooplankton", genus = "pseudocalanus", season = "spring", epu = "MAB")

  
  #GB---------------------------------------------------------------------------------------------------
  ctyp_fall_gb <- process_oi(variable = "zooplankton", genus = "centropages", season = "fall", epu = "GB")
  ctyp_spring_gb <- process_oi(variable = "zooplankton", genus = "centropages", season = "spring", epu = "GB")
  
  tlong_fall_gb <- process_oi(variable = "zooplankton", genus = "temora", season = "fall", epu = "GB")
  tlong_spring_gb <- process_oi(variable = "zooplankton", genus = "temora", season = "spring", epu = "GB")
  
  pseudo_fall_gb <- process_oi(variable = "zooplankton", genus = "pseudocalanus", season = "fall", epu = "GB")
  pseudo_spring_gb <- process_oi(variable = "zooplankton", genus = "pseudocalanus", season = "spring", epu = "GB")
  
  
  #GOM---------------------------------------------------------------------------------------------------
  ctyp_fall_gom <- process_oi(variable = "zooplankton", genus = "centropages", season = "fall", epu = "GOM")
  ctyp_spring_gom <- process_oi(variable = "zooplankton", genus = "centropages", season = "spring", epu = "GOM")
  
  tlong_fall_gom <- process_oi(variable = "zooplankton", genus = "temora", season = "fall", epu = "GOM")
  tlong_spring_gom <- process_oi(variable = "zooplankton", genus = "temora", season = "spring", epu = "GOM")
  
  pseudo_fall_gom <- process_oi(variable = "zooplankton", genus = "pseudocalanus", season = "fall", epu = "GOM")
  pseudo_spring_gom <- process_oi(variable = "zooplankton", genus = "pseudocalanus", season = "spring", epu = "GOM")
  
  #Bind all zoo output. Be sure to include any new species here
  zoo_oi <- NULL
  for (i in ls()){
    if (stringr::str_detect(i,"ctyp|tlong|pseudo")){
      assign("zoo_oi", rbind(zoo_oi, get(i)))
    }
  }
  
  #Process output from masked rasters (mean, +/- 1 SD). Adjust output in process_oi(), not here.
  zoo_oi <- zoo_oi %>% 
    dplyr::rename(EPU = epu) %>%
    dplyr::select(-Season) %>% 
    mutate(Units = "log N m^-3")
  
  #Split out +/- SD because too lazy to gather ;)
  sd.low <- zoo_oi %>% 
    dplyr::select(-Value, -sd.high) %>% 
    mutate(Var = as.factor(paste(Var, "- 1 SD"))) %>% 
    dplyr::rename(Value = sd.low)
  
  sd.high <- zoo_oi %>% 
    dplyr::select(-Value, -sd.low) %>% 
    mutate(Var = as.factor(paste(Var, "+ 1 SD"))) %>% 
    dplyr::rename(Value = sd.high)
  
  zoo_oi <- zoo_oi %>% dplyr::select(-sd.high,-sd.low)
  
  #Bind all data 
  zoo_oi <- rbind(zoo_oi, sd.high, sd.low) %>% as.data.frame()
  
  if (save_clean){
    usethis::use_data(zoo_oi, overwrite = T)
  } else {
    return(zoo_oi)
  }
  
}
```
<!-- {{ProcessSeasAbund2End}} -->

### Plotting

**Abundance anomaly**

```{r, zooplankton-abundance, fig.cap = "*Centropages typicus* abundance anomaly in the Mid-Atlantic Bight.", message = F, warning=F}
# Relative working directories
data.dir  <- here::here('data')
r.dir <- here::here('R')

# Load data
load(file.path(data.dir,"SOE_data_erddap.Rdata"))

# Source plotting functions
source(file.path(r.dir,"BasePlot_source.R"))


#C. typicus abundance anomaly
opar <- par(mar = c(4,4.75,2,4))
soe.plot(SOE.data, "Time", "Centropages typicus abundance anomaly MAB", 
         anomaly = T, stacked = "A", suppressAxis = T, x.start = 1986, cex.stacked = 1.75)
soe.stacked.axis("Year", "Abundance anomaly", rel.x.text = 1.2, rel.y.text = 1.2, 
                 y.line = 3.1, outer = F)

```

**Seasonal Abundance**

```{r MAB-oi-zoo, fig.width=8, fig.cap = "Seasonal abundance of key zooplankton species in the MAB."}
facet_names <- list(
  'centropages spring'=expression(paste(italic("Centropages "), "spring")),
  'centropages fall'=expression(paste(italic("Centropages "), "fall")),
  'temora spring'=expression(paste(italic("Temora "), "spring")),
  'temora fall' = expression(paste(italic("Temora "), "fall")),
  'pseudocalanus spring'=expression(paste(italic("Pseudocalanus "), "spring")),
  'pseudocalanus fall' = expression(paste(italic("Pseudocalanus "), "fall")))

zoo_oi_mab <- ecodata::zoo_oi %>% 
  filter(!str_detect(Var,"SD"),
         EPU == "MAB") %>% 
  
  mutate(Var = str_remove(Var, " zoo"),
         Val2 = exp(Value)) %>% 
      group_by(Var) %>% 
  mutate(hline = mean(Val2, na.rm = T)) %>% 
  separate(.,col = Var, into = c("Species","Season"), remove = F)



top <- zoo_oi_mab %>%  
  filter(Species == "centropages") %>% 

ggplot(aes(x = Time, y = Val2, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = 0, ymax = Inf) +
  geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
  geom_gls() +
  geom_line()+
  geom_point()+
  ylab("") +
  facet_wrap(Var ~ ., ncol = 2, scales='free_x',labeller = label) +
  ggtitle("Zooplankton abundance (OI)") +
  scale_x_continuous(expand = c(0.01, 0.01))+
  scale_y_continuous(trans = "log10")+
  theme_facet() +
    theme(strip.text=element_text(hjust=0,
                                face = "italic"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

middle <- zoo_oi_mab %>%  
  filter(Species == "pseudocalanus") %>% 
ggplot(aes(x = Time, y = Val2, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = 0, ymax = Inf) +
  geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
  geom_gls() +
  geom_line()+
  geom_point()+
  ylab(expression("Abundance num m"^-3*"")) +
  facet_wrap(Var ~ ., ncol = 2, scales='free_x',labeller = label) +
  scale_x_continuous(expand = c(0.01, 0.01))+
  scale_y_continuous(trans = "log10")+
  theme_facet() +
    theme(strip.text=element_text(hjust=0,
                                face = "italic"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

bottom <- zoo_oi_mab %>%  
  filter(Species == "temora") %>% 
ggplot(aes(x = Time, y = Val2, group = Var)) +
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = 0, ymax = Inf) +
  geom_hline(aes(yintercept = hline),
     size = hline.size,
     alpha = hline.alpha,
     linetype = hline.lty)+
    geom_gls() +
  geom_line()+
  geom_point()+
    ylab("") +
  facet_wrap(Var ~ ., ncol = 2,labeller = label) +
  scale_x_continuous(breaks = seq(1980,2010,10),
                     expand = c(0.01, 0.01))+

  theme_facet() +
    theme(strip.text=element_text(hjust=0,
                                face = "italic")) +
   scale_y_log10()

top + middle + bottom + plot_layout(ncol = 1) & theme(plot.margin = margin(0,0,0,0,"cm"))

```
